
<!DOCTYPE html>
<html>
<head>
  <script>
    require(["esri/config", "esri/Map", "esri/views/MapView", "esri/widgets/Locate", "esri/widgets/Search", "esri/layers/GraphicsLayer", "esri/Graphic", "esri/PopupTemplate"], 
    (esriConfig, Map, MapView, Locate, Search, GraphicsLayer, Graphic, PopupTemplate) => {
      // Adding API key
      esriConfig.apiKey = "AAPKf617d57521304ebbbb1ccdfe0a6ab7c9xd9_fQk7Gvm5OOYXsPIGypnSnikFVt3o8pt2rZUIIvbSRkQvtGqxioqliq8SP6xH";

      const map = new Map({
        basemap: "satellite"
      });

      const view = new MapView({
        container: "viewDiv", // Reference to the DOM node that will contain the view
        map: map // References the map object
      });

      const locateBtn = new Locate({
        view: view
      });

      // Add the locate widget to the top left corner of the view
      view.ui.add(locateBtn, {
        position: "top-left"
      });

      // Sets the center point of the view at a specified lon/lat
      view.center = [39, -98];
      view.zoom = 4; // Sets the zoom LOD

      fetch("https://cors-anywhere.herokuapp.com/https://www.fsis.usda.gov/fsis/api/recall/v/1")
        .then(response => response.json())
        .then(data => {
          // Process the data here
          console.log(data);

          // Filter the data
          const activeRecalls = data.filter(item => item.field_active_notice);

          // Group the data by state
          const recallsByState = activeRecalls.reduce((groups, item) => {
            const state = item.field_states;
            if (!groups[state]) {
              groups[state] = [];
            }
            groups[state].push(item);
            return groups;
          }, {});

          // Create a graphic for each state
          const graphics = Object.entries(recallsByState).map(([state, recalls]) => {
            return new Graphic({
              geometry: { // Replace this with the actual geometry of the state
                type: "point",
                longitude: 0,
                latitude: 0
              },
              attributes: {
                recalls: recalls
              }
            });
          });

          // Add the graphics to a layer
          const layer = new GraphicsLayer({
            graphics: graphics
          });
          map.add(layer);

          // Create a popup template
          const template = new PopupTemplate({
            title: "{state}",
            content: "{recalls}",
            fieldInfos: [
              {
                fieldName: "field_title",
                label: "Title"
              },
              {
                fieldName: "field_risk_level",
                label: "Risk Level"
              },
              {
                fieldName: "field_recall_date",
                label: "Recall Date"
              },
              {
                fieldName: "field_recall_reason",
                label: "Recall Reason"
              }
            ]
          });

          // Set the popup template on the layer
          layer.popupTemplate = template;
        })
        .catch(error => {
          console.error("Error:", error);
        });

      const searchWidget = new Search({
        view: view
      });

      // Adds the search widget below other elements in
      // the top left corner of the view
      view.ui.add(searchWidget, {
        position: "top-left",
        index: 2
      });
    });
  </script>
</head>
<body>
  <div id="viewDiv"></div>
</body>
</html>